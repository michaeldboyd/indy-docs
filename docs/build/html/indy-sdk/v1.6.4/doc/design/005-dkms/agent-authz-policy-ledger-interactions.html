
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Agent Authz policy (changes for ledger) &#8212; indy-docs 1.0 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/sidebar.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">indy-docs 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="agent-authz-policy-changes-for-ledger">
<span id="agent-authz-policy-changes-for-ledger"></span><h1>Agent Authz policy (changes for ledger)<a class="headerlink" href="#agent-authz-policy-changes-for-ledger" title="Permalink to this headline">¶</a></h1>
<p><strong>Objective</strong>: Prove agents are authorized to provide proof of claims and authorize and de-authorize other agents</p>
<div class="section" id="assumptions">
<span id="assumptions"></span><h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li>The ledger maintains a global accumulator that holds commitments sent by the agents.</li>
<li>The global accumulator is maintained by the each node so every node knows the accumulator private key</li>
<li>Agent auth policy txns are stored at the identity ledger.</li>
<li>Each auth policy is uniquely identified by a policy address <code class="docutils literal notranslate"><span class="pre">I</span></code>.</li>
<li>One agent can belong to several authz policies, thus several different <code class="docutils literal notranslate"><span class="pre">I</span></code>’s.</li>
<li>An agent can have several authorizations. Following are the list of authorizations:</li>
</ol>
<ul class="simple">
<li>PROVE</li>
<li>PROVE_GRANT</li>
<li>PROVE_REVOKE</li>
<li>ADMIN</li>
</ul>
</div>
<div class="section" id="transactions">
<span id="transactions"></span><h2>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="agent-authz">
<span id="agent-authz"></span><h3>AGENT_AUTHZ<a class="headerlink" href="#agent-authz" title="Permalink to this headline">¶</a></h3>
<p>An authz policy is created/updated by an <code class="docutils literal notranslate"><span class="pre">AGENT_AUTHZ</span></code> transaction. A transaction creating a new authz policy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">transaction</span> <span class="n">sender</span><span class="s1">&#39;s verification key&gt;</span>
    <span class="n">signature</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">signature</span> <span class="n">created</span> <span class="n">by</span> <span class="n">the</span> <span class="n">sender</span><span class="s1">&#39;s public key&gt;,</span>
    <span class="n">req_id</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">nonce</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">operation</span><span class="p">:</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">AGENT_AUTHZ</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span><span class="p">,</span> <span class="n">I</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">verkey</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">optional</span><span class="p">,</span> <span class="n">verification</span> <span class="n">key</span> <span class="n">of</span> <span class="n">the</span> <span class="n">agent</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">authorization</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">optional</span><span class="p">,</span> <span class="n">a</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">commitment</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">optional</span><span class="o">&gt;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></div>
</div>
<p><strong>address</strong>: The policy address, this is a unique identifier of an authz policy. Is a large number (size/range TBD). If the ledger has never seen the provided policy address, it considers the transaction a creation of a new authz policy else it is considered an update of an existing policy identifier by the address.<strong>verkey</strong>: An ed25519 verkey of the agent to which the <code class="docutils literal notranslate"><span class="pre">authorization</span></code> corresponds. This is optional when a new policy is being created as <code class="docutils literal notranslate"><span class="pre">identifier</span></code> is sufficient. This verkey should be kept different from any DID verkey to avoid correlation.<strong>authorization</strong>: A bitset indicating which authorizations are being given to the agent, it is ignored when creating a new policy (the ledger does not know <code class="docutils literal notranslate"><span class="pre">I</span></code>). The various bits indicate different authorizations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="kc">None</span> <span class="p">(</span><span class="n">revoked</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">ADMIN</span> <span class="p">(</span><span class="nb">all</span><span class="p">)</span>
<span class="mi">2</span> <span class="n">PROVE</span>
<span class="mi">3</span> <span class="n">PROVE_GRANT</span>
<span class="mi">4</span> <span class="n">PROVE_REVOKE</span>
<span class="mi">5</span> <span class="s2">&quot;Reserved for future&quot;</span>
<span class="mi">6</span> <span class="s2">&quot;Reserved for future&quot;</span>
<span class="mi">7</span>  <span class="o">...</span> 
   <span class="o">...</span> 
</pre></div>
</div>
<p>While creating a new policy, this field’s value is ignored and the creator agent has all authorizations. For any subsequent policy transactions, the ledger checks if the sender (author to be precise, since anyone can send a transaction once a signature has been done) of transaction has the authorization to make the transaction, eg. The author of txn has <code class="docutils literal notranslate"><span class="pre">PROVE_GRANT</span></code> if it is giving a <code class="docutils literal notranslate"><span class="pre">PROVE</span></code> authorization to another agent.<strong>Future Work</strong>: When we support <code class="docutils literal notranslate"><span class="pre">m-of-n</span></code> authorization, <code class="docutils literal notranslate"><span class="pre">verkey</span></code> would be a map stating the policy and the verkeys</p>
<p><strong>commitment</strong>: This is a number (size/range TBD) given by the agent when it is being given a <code class="docutils literal notranslate"><span class="pre">PROVE</span></code> authorization. Thus this field is only needed when a policy is being created or an agent is being given the <code class="docutils literal notranslate"><span class="pre">PROVE</span></code> authorization. The ledger upon receiving this commitment checks if the commitment is prime and if it is then it updates the global accumulator with this commitment. Efficient primality testing algorithms like BPSW or ECPP can be used but the exact algorithm is yet to be decided.  If the commitment is not prime (in case of creation or update of policy address) then the transaction is rejected. The ledger rejects the transaction if it has already seen the commitment as part of another transaction.
In case of creation of new policy or an agent being given <code class="docutils literal notranslate"><span class="pre">PROVE</span></code> authorization, the ledger responds with the accumulator value after the update with this commitment.</p>
</div>
<div class="section" id="get-agent-authz">
<span id="get-agent-authz"></span><h3>GET_AGENT_AUTHZ<a class="headerlink" href="#get-agent-authz" title="Permalink to this headline">¶</a></h3>
<p>This query is sent by any client to check what the authz policy of any address <code class="docutils literal notranslate"><span class="pre">I</span></code> is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">operation</span><span class="p">:</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">GET_AGENT_AUTHZ</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span><span class="p">,</span> <span class="n">I</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></div>
</div>
<p>The ledger replies with all the agents, their associated authorizations and the commitments of the address <code class="docutils literal notranslate"><span class="pre">I</span></code>.</p>
</div>
<div class="section" id="get-agent-authz-accum">
<span id="get-agent-authz-accum"></span><h3>GET_AGENT_AUTHZ_ACCUM<a class="headerlink" href="#get-agent-authz-accum" title="Permalink to this headline">¶</a></h3>
<p>This query is sent by anyone to get the value of the accumulator.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">operation</span><span class="p">:</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">GET_AGENT_AUTHZ_ACCUM</span><span class="p">,</span>
    <span class="n">accum_id</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">id</span> <span class="n">of</span> <span class="n">either</span> <span class="n">the</span> <span class="n">provisioned</span> <span class="n">agents</span> <span class="n">accumulator</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">revoked</span> <span class="n">agent</span> <span class="n">accumulator</span><span class="o">&gt;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></div>
</div>
<p>The ledger returns the global accumulator with the id. Both accumulators are add only; the client checks that commitment is present in one accumulator AND not present in other accumulator.</p>
</div>
</div>
<div class="section" id="data-structures">
<span id="data-structures"></span><h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ledger">
<span id="ledger"></span><h3>Ledger<a class="headerlink" href="#ledger" title="Permalink to this headline">¶</a></h3>
<p>Each authz transaction goes in the identity ledger.</p>
</div>
<div class="section" id="state-trie">
<span id="state-trie"></span><h3>State trie.<a class="headerlink" href="#state-trie" title="Permalink to this headline">¶</a></h3>
<p>The state stores:</p>
<ol class="simple">
<li>Accumulator: The accumulator is stored in the trie at name <code class="docutils literal notranslate"><span class="pre">&lt;special</span> <span class="pre">byte</span> <span class="pre">denoting</span> <span class="pre">an</span> <span class="pre">authz</span> <span class="pre">prove</span> <span class="pre">accumulator&gt;</span></code> with value as the value of accumulator.</li>
<li>Policies: The state stores one name for each policy, the name is <code class="docutils literal notranslate"><span class="pre">&lt;special</span> <span class="pre">byte</span> <span class="pre">denoting</span> <span class="pre">an</span> <span class="pre">authz</span> <span class="pre">policy&gt;:&lt;policy</span> <span class="pre">address&gt;</span></code>, the value at this name is a hash. The hash is determined deterministically serializing (RLP encoding from ethereum, we already use this) this data structure:</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">[</span><span class="o">&lt;</span><span class="n">agent</span> <span class="n">verkey1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">]],</span>
  <span class="p">[</span><span class="o">&lt;</span><span class="n">agent</span> <span class="n">verkey2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">]],</span>
  <span class="p">[</span><span class="o">&lt;</span><span class="n">agent</span> <span class="n">verkey3</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">]],</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The hash of above can then be used to lookup (it is not, more on this later) the exact authorization policy in a separate name-value store. This is done to keep the database backing the state (trie) smaller.</p>
</div>
<div class="section" id="caches">
<span id="caches"></span><h3>Caches<a class="headerlink" href="#caches" title="Permalink to this headline">¶</a></h3>
<p>There is an agent_authz cache used for optimisations are:
The cache is a name-value store (leveldb) and offers a constant lookup time for lookup by name.</p>
<ol class="simple">
<li>Policy values: The authorization of each agent per policy. The values for the keys are rlp encoding of the list of at most 2 items, <code class="docutils literal notranslate"><span class="pre">authorization</span> <span class="pre">bitset</span></code> with each bit respresenting a different auth, <code class="docutils literal notranslate"><span class="pre">commitment</span></code> is optional and relevant only when agent has the <code class="docutils literal notranslate"><span class="pre">PROVE</span></code> authorization.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span> <span class="mi">1</span><span class="o">&gt;&lt;</span><span class="n">delimiter</span><span class="o">&gt;&lt;</span><span class="n">agent</span> <span class="n">verkey</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span> <span class="mi">1</span><span class="o">&gt;&lt;</span><span class="n">delimiter</span><span class="o">&gt;&lt;</span><span class="n">agent</span> <span class="n">verkey</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span> <span class="mi">1</span><span class="o">&gt;&lt;</span><span class="n">delimiter</span><span class="o">&gt;&lt;</span><span class="n">agent</span> <span class="n">verkey</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span> <span class="mi">2</span><span class="o">&gt;&lt;</span><span class="n">delimiter</span><span class="o">&gt;&lt;</span><span class="n">agent</span> <span class="n">verkey</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">&lt;</span><span class="n">policy</span> <span class="n">address</span> <span class="mi">2</span><span class="o">&gt;&lt;</span><span class="n">delimiter</span><span class="o">&gt;&lt;</span><span class="n">agent</span> <span class="n">verkey</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">authorization</span> <span class="n">bitset</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">commitment</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="o">....</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These names are used by the nodes during processing any transaction.</p>
<ol class="simple">
<li>Accumulator value: Value of each accumulator is stored corresponding to the special byte indicating the global accumulator.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="o">&lt;</span><span class="n">special_byte</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">accumulator</span> <span class="n">value</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>During processing of any write transaction, the node updates the ledger, state and caches after the txn is successful but for querying (client as well as its own like validation, etc) it only uses caches since caches are more efficient than state trie. The state trie is only used for state proofs.</p>
<ol class="simple">
<li>TODO: Maintaining a set of commitments: Each node maintains a set of see commitments and does not allow duplicate commitments. Its kept in key value store with constant lookup time for commitment lookup.</li>
</ol>
</div>
</div>
<div class="section" id="code-organisation">
<span id="code-organisation"></span><h2>Code organisation.<a class="headerlink" href="#code-organisation" title="Permalink to this headline">¶</a></h2>
<p>These changes would be implemented as a separate plugin. The plugin will not introduce new ledger or state but will introduce the cache described above. The plugin will introduce a new request handler which will subclass the <code class="docutils literal notranslate"><span class="pre">DomainRequestHandler</span></code>. The plugin’s new request handler will introduce 1 <code class="docutils literal notranslate"><span class="pre">write_type</span></code> and 2 <code class="docutils literal notranslate"><span class="pre">query_types</span></code> and methods to handle those.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Agent Authz policy (changes for ledger)</a><ul>
<li><a class="reference internal" href="#assumptions">Assumptions</a></li>
<li><a class="reference internal" href="#transactions">Transactions</a><ul>
<li><a class="reference internal" href="#agent-authz">AGENT_AUTHZ</a></li>
<li><a class="reference internal" href="#get-agent-authz">GET_AGENT_AUTHZ</a></li>
<li><a class="reference internal" href="#get-agent-authz-accum">GET_AGENT_AUTHZ_ACCUM</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-structures">Data structures</a><ul>
<li><a class="reference internal" href="#ledger">Ledger</a></li>
<li><a class="reference internal" href="#state-trie">State trie.</a></li>
<li><a class="reference internal" href="#caches">Caches</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-organisation">Code organisation.</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../../_sources/indy-sdk/v1.6.4/doc/design/005-dkms/agent-authz-policy-ledger-interactions.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">indy-docs 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Michael McKean.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>